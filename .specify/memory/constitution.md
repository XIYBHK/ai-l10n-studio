<!--
同步影响报告 (Sync Impact Report)
==================================
版本变更: 初始版本 → 1.0.0
创建日期: 2025-10-14

新增章节:
- 核心原则 (8项)
- 架构约束
- 开发工作流程
- 治理规则

需要更新的模板:
- ✅ .specify/templates/plan-template.md (已对齐)
- ✅ .specify/templates/spec-template.md (已对齐)
- ✅ .specify/templates/tasks-template.md (已对齐)

待办事项:
- 无
-->

# AI L10n Studio Constitution

本宪章定义 AI L10n Studio 项目的不可协商原则和开发规范。

## 核心原则

### I. 四层架构分离 (Architecture Layering)

**强制要求**:

- 前端组件层 → AppDataProvider 数据层 → 命令层 (commands.ts) → Rust 服务层
- 跨层调用必须通过定义的接口，禁止跨层直接访问
- 每层职责单一：
  - 组件层：UI 渲染和用户交互
  - 数据层：全局状态管理、缓存、事件同步
  - 命令层：类型安全的 IPC 调用、统一错误处理
  - 服务层：业务逻辑、数据持久化

**理由**: 清晰的架构分层确保代码可维护性，便于测试和重构。违反分层会导致耦合增加和代码混乱。

### II. 测试优先 (Test-First)

**强制要求**:

- 新功能必须先写测试，确保测试失败后再实现功能
- 遵循 Red-Green-Refactor 循环：编写失败的测试 → 实现最小代码使测试通过 → 重构
- 测试覆盖率要求：核心业务逻辑 ≥ 80%
- 集成测试覆盖关键用户流程
- 测试必须独立运行，不依赖外部服务（使用 mock）

**理由**: 测试先行确保需求明确、设计合理，避免过度设计。测试是代码质量的第一道防线。

### III. 统一错误处理 (Unified Error Handling)

**强制要求**:

- 前端：所有 Tauri 命令调用通过 `commands.ts` 的统一错误处理
- 后端：所有服务层错误使用 `anyhow::Result` 或 `thiserror::Error`
- 错误日志统一格式：`[模块名] 错误类型: 详细信息`
- 用户可见错误必须提供清晰的中文提示和建议操作
- 禁止裸露的 `.unwrap()` 和 `.expect()`（仅测试代码例外）

**理由**: 统一的错误处理简化调试，提升用户体验，降低维护成本。

### IV. 无遗留代码 (No Legacy Code)

**强制要求**:

- 功能重构时必须删除旧代码和旧接口，不允许注释保留
- 不允许存在未使用的导入、变量、函数
- API 变更时必须一次性更新所有调用方
- 使用 `@deprecated` 标记的代码必须在下一个版本中移除

**理由**: 遗留代码增加认知负担，容易引发混淆和 bug。保持代码库干净是持续迭代的前提。

### V. 单一职责原则 (Single Responsibility)

**强制要求**:

- 一个函数只做一件事，复杂功能必须拆分
- 函数长度限制：前端 ≤ 50 行，后端 ≤ 100 行（复杂算法除外）
- 组件职责单一：数据获取、UI 渲染、业务逻辑分离
- 服务模块职责明确：`ai_translator.rs` 负责 AI 调用，`batch_translator.rs` 负责批处理逻辑

**理由**: 职责明确的代码易于理解、测试和复用。大函数是代码坏味道的典型标志。

### VI. 类型安全优先 (Type Safety First)

**强制要求**:

- TypeScript 严格模式：`strict: true`，禁止 `any` 类型（除非有充分理由并注释说明）
- Rust 必须通过 `cargo clippy` 检查，零警告
- 前后端类型共享：关键数据结构使用 `ts-rs` 自动生成 TypeScript 类型
- 接口变更必须在编译时发现，不允许运行时类型错误

**理由**: 强类型系统是防止 bug 的最有效手段，编译时错误远比运行时错误容易修复。

### VII. 小步提交 (Atomic Commits)

**强制要求**:

- 每次提交只做一个改动（一个 bug 修复、一个小功能、一次重构）
- 提交信息格式：`类型(范围): 简短描述`
  - 类型：`feat`（新功能）、`fix`（bug 修复）、`refactor`（重构）、`test`（测试）、`docs`（文档）、`chore`（杂项）
  - 范围：模块名或组件名
  - 示例：`feat(translator): 添加批量翻译进度显示`
- 提交前必须通过 lint 检查和测试

**理由**: 原子提交便于代码审查、问题定位和版本回滚。清晰的提交历史是团队协作的基础。

### VIII. 文档简洁 (Minimal Documentation)

**强制要求**:

- 代码优先：好的代码应当自解释，减少注释依赖
- 必需文档：README、CHANGELOG、API 文档（命令接口）
- 禁止创建：设计文档归档、会议记录、过期的技术方案（任务完成后更新 CHANGELOG 即可）
- CHANGELOG 采用简洁格式：版本号 + 主要变更 + 相关文件

**理由**: 文档维护成本高且容易过时。代码和测试是最可靠的文档来源。

## 架构约束

### 技术栈锁定

**前端**:

- React 18 + TypeScript（严格模式）
- Ant Design 5（UI 组件库）
- Zustand（轻量状态管理）
- SWR（数据缓存和同步）

**后端**:

- Tauri 2.x + Rust Edition 2024
- Tokio（异步运行时）
- nom（PO 文件解析）
- parking_lot（高性能锁）

**理由**: 统一技术栈降低学习成本，避免技术债务积累。

### 依赖管理

**强制要求**:

- 新增依赖必须评估：是否必需、维护状态、License、体积影响
- 禁止引入功能重复的依赖（例如同时使用 lodash 和 ramda）
- 定期更新依赖（每月检查一次安全更新）

**理由**: 依赖膨胀导致构建缓慢、安全风险和维护负担。

### 性能标准

**强制要求**:

- 小文件（< 10MB）加载时间 < 1 秒
- 大文件（10-50MB）加载时间 < 3 秒
- UI 操作响应时间 < 100ms（使用防抖/节流优化）
- 批量翻译进度更新间隔 = 100ms（避免 UI 卡顿）

**理由**: 性能直接影响用户体验，必须在设计阶段考虑。

## 开发工作流程

### 功能开发流程

1. **需求明确**: 编写用户故事和验收标准（spec.md）
2. **测试先行**: 编写失败的测试（TDD）
3. **最小实现**: 实现最小代码使测试通过
4. **重构优化**: 在测试保护下重构代码
5. **代码审查**: 提交 PR，至少一人审查
6. **文档更新**: 更新 CHANGELOG.md

### 代码审查要求

**审查清单**:

- [ ] 符合核心原则（特别是架构分层、单一职责）
- [ ] 测试充分且通过
- [ ] 无 TypeScript/Clippy 警告
- [ ] 提交信息清晰
- [ ] 无遗留代码和未使用导入

### 持续集成 (CI)

**CI 流程** (`.github/workflows/check.yml`):

1. Lint 检查（`npm run lint:all`）
2. 前端测试（`npm run test:ci`）
3. 前端构建（`npm run build`）
4. Rust Clippy 检查（`cargo clippy --all-targets --all-features -- -D warnings`）
5. Rust 测试（`cargo test`）

**强制要求**: 所有 CI 步骤必须通过才能合并 PR。

## 治理规则

### 宪章修订

**修订流程**:

1. 提出修订理由和具体内容
2. 团队讨论和投票（至少 2/3 同意）
3. 更新宪章版本号（语义化版本控制）
4. 同步更新相关模板和文档
5. 记录在 CHANGELOG.md

**版本控制**:

- **MAJOR**: 移除或重新定义核心原则（破坏性变更）
- **MINOR**: 新增原则或章节
- **PATCH**: 措辞修正、示例更新

### 合规性检查

**定期检查** (每季度):

- 架构分层是否清晰（无跨层调用）
- 测试覆盖率是否达标
- 依赖是否有安全更新
- CI 流程是否有效

**违规处理**:

- 技术债务必须记录在 GitHub Issues
- 重大违规（如跳过测试）需立即修复
- 重复违规需团队讨论改进措施

### 例外情况

**允许例外的场景**:

- 快速原型验证（必须在下一个版本中补齐测试和文档）
- 紧急 bug 修复（可先修复后补测试，但必须在 24 小时内完成）
- 第三方库限制（无法满足类型安全要求）

**例外申请**: 在 PR 中注释说明理由，团队审查批准。

---

**版本**: 1.0.0 | **批准日期**: 2025-10-14 | **最后修订**: 2025-10-14
