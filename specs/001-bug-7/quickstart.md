# Quick Start: BUG修复验证指南

**Feature**: 关键用户界面和功能问题修复  
**Date**: 2025-10-14  
**Purpose**: 快速验证每个BUG的修复效果

## 前置条件

```bash
# 1. 启动开发服务器
npm run tauri:dev

# 2. 确保有可用的AI配置（Moonshot/OpenAI）
# 如果没有，第一步验证时会自动打开设置窗口
```

---

## P1 修复验证（阻塞性问题）

### ✅ 验证1: AI配置保存

**预期结果**: 测试连接成功后，点击保存能成功保存配置

**操作步骤**:

1. 打开应用（如无AI配置，自动打开设置窗口）
2. 点击"添加AI配置"
3. 填写表单：
   - 配置名称：`My Moonshot`
   - 提供商：`Moonshot AI`
   - API密钥：`sk-xxx...`（真实密钥）
   - 模型：`moonshot-v1-8k`
4. 点击"测试连接" → 应显示"连接成功"
5. 点击"保存"

**验证成功标志**:

- ✅ 不显示"保存配置失败"错误
- ✅ 显示"保存成功"提示
- ✅ 设置对话框自动关闭
- ✅ 配置列表中出现新配置

**验证失败标志**:

- ❌ 显示"添加AI配置失败"
- ❌ 控制台错误：`missing field api_key`

**对应日志** (成功):

```
[INFO] [SettingsModal] 连接测试完成 {success: true, message: 连接成功 (Moonshot AI)}
[INFO] [ConfigDraft] 配置已保存并发送更新事件
[INFO] [TauriEventBridge] 接收到事件: config:updated
```

---

### ✅ 验证2: 系统提示词保存

**预期结果**: 修改系统提示词后能成功保存

**操作步骤**:

1. 打开设置 → 切换到"系统提示词"标签
2. 修改提示词内容（添加一行文本）：
   ```
   你是专业翻译专家，请严格遵循术语库规范。
   ```
3. 点击"保存"

**验证成功标志**:

- ✅ 显示"保存成功"提示
- ✅ 无错误弹窗
- ✅ 重新打开设置，提示词内容已保存

**验证失败标志**:

- ❌ 显示"设置系统提示词失败"
- ❌ 控制台错误：`Command set_system_prompt not found`

**对应日志** (成功):

```
[INFO] [SettingsModal] 系统提示词已保存
[INFO] [ConfigDraft] 配置已保存并发送更新事件
```

---

### ✅ 验证3: 文件加载后语言检测

**预期结果**: 加载PO文件后，自动检测源语言并推荐目标语言，无错误提示

**操作步骤**:

1. 准备一个英文PO文件（或使用测试文件）
2. 点击"打开文件" → 选择PO文件
3. 等待文件加载完成

**验证成功标志**:

- ✅ 显示"文件加载成功"
- ✅ 自动检测到源语言（如"English"）
- ✅ 自动推荐目标语言（如"简体中文"）
- ✅ 无错误弹窗

**验证失败标志**:

- ❌ 弹窗："获取默认目标语言失败"
- ❌ 控制台错误：`missing required key sourceLangCode`

**对应日志** (成功):

```
[INFO] [App] 检测到源语言 {code: en, name: English}
[INFO] [App] 推荐目标语言 {code: zh-CN, name: 简体中文}
[INFO] [App] 文件加载成功 {filePath: ..., entryCount: 844}
```

---

## P2 修复验证（用户体验问题）

### ✅ 验证4: 主题切换响应

**预期结果**: 点击一次主题切换按钮，主题立即切换

**操作步骤**:

1. 确认当前主题（如亮色）
2. 点击右上角的主题切换按钮（🌙/☀️图标）**一次**
3. 观察界面变化

**验证成功标志**:

- ✅ 点击一次后，界面立即切换到暗色模式
- ✅ 图标立即从☀️变为🌙
- ✅ 再点击一次，立即切换回亮色

**验证失败标志**:

- ❌ 需要点击两次才切换
- ❌ 第一次点击无反应

**快速测试**:

```
连续点击3次 → 主题应变化3次（奇数次与初始不同）
```

---

### ✅ 验证5: 跟随系统主题

**预期结果**: 选择"跟随系统"后，应用主题与操作系统主题保持一致

**操作步骤**:

#### Windows:

1. 打开设置 → "外观与语言" → 主题模式选择"跟随系统"
2. 打开 Windows 设置 → 个性化 → 颜色
3. 切换"选择模式"：深色 ↔ 浅色
4. 观察应用主题变化

#### macOS:

1. 应用设置选择"跟随系统"
2. 系统偏好设置 → 通用 → 外观
3. 切换：浅色 ↔ 深色
4. 观察应用主题变化

**验证成功标志**:

- ✅ 操作系统切换到暗色 → 应用自动切换到暗色
- ✅ 操作系统切换到亮色 → 应用自动切换到亮色
- ✅ 实时响应（无需重启应用）

**验证失败标志**:

- ❌ 操作系统切换后，应用主题不变
- ❌ 需要重启应用才生效

**对应代码**:

```typescript
// useTheme.ts 应监听系统事件
const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
mediaQuery.addEventListener('change', handleSystemThemeChange);
```

---

### ✅ 验证6: 界面语言切换

**预期结果**: 切换语言后，所有界面文本立即变化

**操作步骤**:

1. 打开设置 → "外观与语言" → 语言选择
2. 当前语言：简体中文
3. 切换到：English
4. 观察界面变化

**验证成功标志**:

- ✅ 菜单栏文本变为英文（"Open" "Save" "Settings"）
- ✅ 按钮文本变为英文（"Translate" "Cancel" "Apply"）
- ✅ 设置对话框所有标签变为英文
- ✅ 1秒内完成切换（允许短暂加载）

**验证失败标志**:

- ❌ 界面无任何变化
- ❌ 部分文本未切换
- ❌ 关闭设置重新打开才生效

**对应日志** (成功):

```
[INFO] [SettingsModal] 应用语言已切换 {language: en-US}
[INFO] [TauriStore] 保存成功
```

---

## P3 修复验证（改进项）

### ✅ 验证7: 打开日志目录

**预期结果**: 点击"打开日志目录"按钮，文件管理器打开日志文件夹

**操作步骤**:

1. 打开设置 → "日志设置" 标签
2. 点击"打开日志目录"按钮
3. 等待文件管理器打开

**验证成功标志**:

- ✅ Windows: Explorer 打开日志目录
- ✅ macOS: Finder 打开日志目录
- ✅ Linux: 默认文件管理器打开
- ✅ 目录中包含 `.log` 文件

**验证失败标志**:

- ❌ 无反应
- ❌ 错误提示："日志目录不存在"

**日志目录位置**:

```
Windows: %APPDATA%\po-translator-gui\logs\
macOS:   ~/Library/Application Support/po.translator.gui/logs/
Linux:   ~/.config/po-translator-gui/logs/
```

---

## 回归测试（确保未破坏现有功能）

### ✅ 回归1: 批量翻译仍正常

**操作步骤**:

1. 加载一个PO文件
2. 点击"批量翻译"
3. 观察进度和结果

**验证成功标志**:

- ✅ 进度条正常显示
- ✅ 统计信息正确（TM命中、去重、AI调用）
- ✅ 翻译结果正确写入

---

### ✅ 回归2: 术语库仍正常

**操作步骤**:

1. 打开术语库管理器
2. 添加一个新术语
3. 保存并翻译包含该术语的条目

**验证成功标志**:

- ✅ 术语库保存成功
- ✅ 翻译时自动应用术语
- ✅ 风格提示词生成正确

---

### ✅ 回归3: 配置持久化

**操作步骤**:

1. 修改任意配置（主题、语言、AI配置）
2. 完全关闭应用
3. 重新启动应用

**验证成功标志**:

- ✅ 所有配置保持不变
- ✅ 主题保持
- ✅ 语言保持
- ✅ AI配置保持

---

## 测试矩阵

| 测试项               | 预期结果         | 实际结果 | 通过? | 备注 |
| -------------------- | ---------------- | -------- | ----- | ---- |
| P1-1: AI配置保存     | 保存成功，无错误 |          | ☐     |      |
| P1-2: 系统提示词保存 | 保存成功，无错误 |          | ☐     |      |
| P1-3: 语言检测       | 自动检测，无错误 |          | ☐     |      |
| P2-4: 主题切换       | 单次点击生效     |          | ☐     |      |
| P2-5: 跟随系统       | 实时跟随OS       |          | ☐     |      |
| P2-6: 语言切换       | 界面文本变化     |          | ☐     |      |
| P3-7: 打开日志       | 文件管理器打开   |          | ☐     |      |
| R-1: 批量翻译        | 功能正常         |          | ☐     |      |
| R-2: 术语库          | 功能正常         |          | ☐     |      |
| R-3: 持久化          | 重启后保持       |          | ☐     |      |

---

## 性能基准

修复后应保持或改善性能：

| 指标         | 目标值  | 测量方法                 |
| ------------ | ------- | ------------------------ |
| 配置保存延迟 | < 100ms | 点击保存到显示成功的时间 |
| 主题切换延迟 | < 100ms | 点击按钮到界面变化的时间 |
| 语言切换延迟 | < 1s    | 选择语言到文本变化的时间 |
| 日志目录打开 | < 2s    | 点击按钮到文件管理器打开 |

**测量方法**:

```typescript
console.time('saveConfig');
await aiConfigCommands.add(config);
console.timeEnd('saveConfig'); // 应 < 100ms
```

---

## 边界情况测试

### 1. 空值和特殊字符

- [ ] API密钥包含特殊字符（`!@#$%^&*()`）
- [ ] 系统提示词包含Emoji 🚀
- [ ] 系统提示词超长（10000字符）
- [ ] 配置名称为空

### 2. 并发操作

- [ ] 快速连续点击主题切换按钮5次
- [ ] 同时打开两个设置窗口（如果可能）
- [ ] 翻译过程中切换主题/语言

### 3. 网络和文件系统

- [ ] 无网络时测试AI连接（应显示明确错误）
- [ ] 日志目录被删除时点击"打开日志目录"
- [ ] 配置文件损坏时启动应用

---

## 调试技巧

### 查看详细日志

```typescript
// 前端日志
import { createModuleLogger } from '@/utils/logger';
const log = createModuleLogger('Debug');
log.debug('当前配置:', config);

// 后端日志
// 查看 logs/ 目录下的最新日志文件
```

### 检查事件触发

```typescript
import { eventDispatcher } from '@/services/eventDispatcher';

// 监听所有事件
eventDispatcher.onAll((event, payload) => {
  console.log('[Event]', event, payload);
});

// 查看事件历史
console.table(eventDispatcher.getEventHistory());
```

### 检查配置文件

```bash
# Windows
%APPDATA%\po-translator-gui\app_config.json

# macOS
~/Library/Application Support/po.translator.gui/app_config.json

# Linux
~/.config/po-translator-gui/app_config.json
```

---

## 测试完成清单

- [ ] 所有P1测试通过（阻塞性问题）
- [ ] 所有P2测试通过（用户体验）
- [ ] P3测试通过（改进项）
- [ ] 回归测试通过（现有功能）
- [ ] 性能基准符合要求
- [ ] 边界情况测试通过
- [ ] 无控制台错误或警告
- [ ] 代码通过 Lint 检查
- [ ] 所有测试用例通过

---

## 下一步

测试通过后：

1. 提交代码到 `001-bug-7` 分支
2. 更新 `CHANGELOG.md`
3. 创建 Pull Request
4. 代码审查
5. 合并到 `main` 分支
