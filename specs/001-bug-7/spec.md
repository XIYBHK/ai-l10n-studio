# Feature Specification: 关键用户界面和功能问题修复

**Feature Branch**: `001-bug-7`  
**Created**: 2025-10-14  
**Status**: Draft  
**Input**: User description: "BUG修复 手动测试结果：7个关键用户界面和功能问题"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - AI配置保存失败修复 (Priority: P1)

用户在设置界面添加新的AI供应商配置时，测试连接功能正常工作，但点击保存按钮后系统报错"保存配置失败：添加AI配置失败"，导致用户无法保存配置并使用AI翻译功能。

**Why this priority**: 这是阻塞性问题。用户无法配置AI供应商意味着核心翻译功能完全不可用，直接影响产品的基本价值交付。

**Independent Test**: 打开设置对话框 → 添加AI配置 → 输入API密钥 → 测试连接成功 → 点击保存 → 验证配置已保存且不显示错误提示。

**Acceptance Scenarios**:

1. **Given** 用户在设置界面填写了新的AI供应商配置（包括API密钥），**When** 用户点击"测试连接"按钮且测试通过后点击"保存"按钮，**Then** 系统成功保存配置，显示成功提示，关闭设置对话框，配置立即生效
2. **Given** 用户修改现有AI配置的API密钥，**When** 用户测试连接成功后保存，**Then** 系统更新配置而不报错
3. **Given** 用户输入的API密钥为空或格式错误，**When** 用户尝试保存，**Then** 系统显示明确的字段验证错误而非通用保存失败错误

---

### User Story 2 - 系统提示词保存失败修复 (Priority: P1)

用户在设置界面的"系统提示词"标签页修改提示词内容后，点击保存按钮系统报错"设置系统提示词失败"，导致用户无法自定义翻译行为。

**Why this priority**: 系统提示词是专业翻译场景的关键功能，允许用户根据不同领域定制翻译风格。此功能完全不可用会严重影响专业用户的使用体验。

**Independent Test**: 打开设置对话框 → 切换到"系统提示词"标签 → 修改提示词内容 → 点击保存 → 验证提示词已保存且下次翻译时生效。

**Acceptance Scenarios**:

1. **Given** 用户在系统提示词输入框中修改了内容，**When** 用户点击保存按钮，**Then** 系统成功保存提示词，显示成功提示，后续翻译使用新提示词
2. **Given** 用户清空了系统提示词，**When** 用户点击保存，**Then** 系统保存空提示词或恢复默认提示词（基于设计决策）
3. **Given** 用户输入了超长提示词（如10000字符），**When** 用户保存，**Then** 系统要么成功保存，要么显示明确的长度限制提示

---

### User Story 3 - 文件加载后语言检测失败修复 (Priority: P1)

用户通过"打开文件"加载待翻译的PO文件后，系统弹出错误提示"获取默认目标语言失败"，影响用户的正常翻译流程。

**Why this priority**: 这是主要工作流程的阻塞问题。虽然文件加载成功，但语言检测失败会导致用户需要手动选择目标语言，增加摩擦并可能导致选择错误的语言。

**Independent Test**: 点击"打开文件" → 选择一个英文PO文件 → 验证文件成功加载且系统自动检测源语言并推荐合适的目标语言，无错误提示。

**Acceptance Scenarios**:

1. **Given** 用户加载了一个源语言为英语的PO文件，**When** 文件解析完成，**Then** 系统自动检测源语言为英语，推荐目标语言为中文（基于用户系统语言或历史偏好），无错误提示
2. **Given** 用户加载了一个源语言未知或混合语言的文件，**When** 语言检测不确定，**Then** 系统使用合理的默认值（如英语→中文），显示提示但不报错
3. **Given** 用户之前翻译过同一文件，**When** 再次加载，**Then** 系统记住上次使用的目标语言

---

### User Story 4 - 主题切换响应修复 (Priority: P2)

用户点击首页右上角的暗色/亮色主题切换按钮时，需要点击两次主题才会真正切换，造成用户困惑和操作不便。

**Why this priority**: 虽然不阻塞核心功能，但这是高频交互的用户体验问题，直接影响用户对产品质量的感知。

**Independent Test**: 在亮色模式下点击主题切换按钮一次 → 验证界面立即切换到暗色模式，再点击一次 → 验证立即切换回亮色模式。

**Acceptance Scenarios**:

1. **Given** 当前主题为亮色，**When** 用户点击主题切换按钮一次，**Then** 界面立即切换到暗色主题，按钮图标更新
2. **Given** 当前主题为暗色，**When** 用户点击主题切换按钮一次，**Then** 界面立即切换到亮色主题，按钮图标更新
3. **Given** 用户快速连续点击主题切换按钮3次，**When** 操作完成，**Then** 主题正确反映最终状态（点击奇数次与初始状态不同，偶数次相同）

---

### User Story 5 - 外观设置功能修复 (Priority: P2)

用户在设置界面的"外观与语言"标签页进行操作时遇到两个问题：(1) "跟随系统"选项不生效，主题不会随系统变化；(2) 切换界面语言到英语后界面没有任何变化。

**Why this priority**: 这些是重要的本地化和个性化功能，影响用户舒适度和国际化用户体验，但不阻塞核心翻译功能。

**Independent Test**: 
- 跟随系统：选择"跟随系统"选项 → 切换操作系统主题 → 验证应用主题自动跟随变化
- 语言切换：选择英语语言 → 点击保存 → 验证界面文本切换为英文

**Acceptance Scenarios**:

1. **Given** 用户在外观设置中选择"跟随系统"选项，**When** 操作系统主题从亮色切换到暗色，**Then** 应用在下次启动或实时（如支持）自动切换到暗色主题
2. **Given** 用户在外观设置中选择"跟随系统"选项且当前为暗色，**When** 操作系统切换到亮色，**Then** 应用同步切换到亮色
3. **Given** 用户在语言设置中选择"English"，**When** 点击保存或应用按钮，**Then** 界面所有文本（菜单、按钮、提示）立即切换为英文
4. **Given** 用户切换到英语后关闭应用，**When** 重新启动应用，**Then** 界面保持英文状态

---

### User Story 6 - 日志管理改进 (Priority: P3)

用户在设置界面的"日志设置"标签页想要快速访问日志文件时，没有直接打开日志目录的按钮，需要记住路径并手动导航，且当前页面排版过于疏松浪费空间。

**Why this priority**: 这是用户体验改进而非Bug修复，对调试和技术支持有帮助但不影响核心功能。

**Independent Test**: 打开设置 → 切换到"日志设置"标签 → 点击"打开日志目录"按钮 → 验证系统文件管理器打开日志文件夹。

**Acceptance Scenarios**:

1. **Given** 用户在"日志设置"标签页，**When** 用户点击"打开日志目录"按钮，**Then** 系统打开文件管理器并定位到日志文件所在目录
2. **Given** 日志目录不存在或不可访问，**When** 用户点击"打开日志目录"按钮，**Then** 系统显示友好的错误提示（如"日志目录不存在，请检查应用配置"）
3. **Given** 用户查看日志设置页面，**When** 页面渲染完成，**Then** 布局紧凑合理，标签和控件间距适中，无大片空白区域

---

### Edge Cases

- **配置保存时网络中断**: 用户保存AI配置时网络连接中断，系统应显示明确的网络错误而非通用保存失败
- **并发修改配置**: 用户在多个窗口同时修改配置，系统应避免数据竞争和配置丢失
- **超长输入**: 用户输入超长的API密钥或系统提示词，系统应验证长度或正确处理
- **特殊字符**: 系统提示词或配置包含特殊字符（引号、反斜杠等），系统应正确转义和保存
- **主题切换时加载延迟**: 用户在主题切换过程中快速连续点击，系统应防止状态混乱
- **语言切换时未翻译文本**: 某些界面文本缺少翻译时，系统应回退到默认语言而非显示空白
- **跟随系统时OS不支持**: 在不支持系统主题检测的旧版操作系统上，"跟随系统"选项应禁用或显示说明
- **日志目录权限问题**: 用户没有读取日志目录的权限时，"打开日志目录"功能应给出明确提示

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统保存AI配置时，必须正确验证所有必填字段（API密钥、提供商类型、模型等），缺失字段应给出明确的错误提示而非通用失败消息
- **FR-002**: 系统保存AI配置时，必须正确序列化数据并传递给后端命令，确保数据结构与后端期望一致
- **FR-003**: 系统提示词保存功能必须调用正确的后端命令，命令名称和参数格式必须与后端注册的命令一致
- **FR-004**: 文件加载后的语言检测功能必须正确传递参数到后端命令，参数命名（如sourceLangCode vs source_lang_code）必须与后端期望匹配
- **FR-005**: 主题切换按钮点击时，必须立即更新主题状态并触发界面重新渲染，避免状态与UI不同步
- **FR-006**: "跟随系统"选项启用时，系统必须监听操作系统的主题变化事件并实时或在下次启动时同步更新应用主题
- **FR-007**: 语言切换功能必须加载对应的语言包，更新所有界面文本，并持久化用户的语言偏好
- **FR-008**: 日志设置页面必须提供"打开日志目录"按钮，点击后调用系统API打开文件管理器并导航到日志目录
- **FR-009**: 所有配置保存操作必须提供明确的成功或失败反馈，失败时必须显示具体的错误原因（如"缺少API密钥"而非"保存失败"）
- **FR-010**: 系统必须记录所有配置保存失败的详细错误日志，包括请求参数、后端返回信息、错误堆栈，以便排查问题

### Key Entities

- **AI配置 (AI Configuration)**: 包含提供商类型、API密钥、模型选择、基础URL等属性，用于连接和使用AI翻译服务
- **系统提示词 (System Prompt)**: 用户自定义的翻译指导文本，影响AI翻译的风格和行为
- **主题设置 (Theme Settings)**: 包含主题模式（亮色/暗色/跟随系统）、实际生效的主题状态
- **语言偏好 (Language Preference)**: 用户选择的界面语言（中文/英文等），影响所有UI文本显示
- **日志配置 (Log Configuration)**: 日志级别、日志目录路径、轮转策略等设置

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用户首次配置AI供应商时，从打开设置到保存成功的完成率达到95%以上（当前由于保存失败可能为0%）
- **SC-002**: 用户修改系统提示词并保存的操作成功率达到100%（当前为0%）
- **SC-003**: 用户加载PO文件后，系统自动检测目标语言的成功率达到95%以上，无错误提示弹出
- **SC-004**: 用户点击主题切换按钮一次后，主题在100毫秒内完成切换，无需第二次点击
- **SC-005**: 用户启用"跟随系统"主题选项后，应用主题与操作系统主题保持一致（实时或重启后同步）
- **SC-006**: 用户切换界面语言后，95%以上的界面文本在1秒内完成切换（少数未翻译项可回退到默认语言）
- **SC-007**: 用户点击"打开日志目录"按钮后，文件管理器在2秒内打开并定位到日志目录
- **SC-008**: 所有配置保存失败的场景下，错误提示包含具体原因（如"API密钥不能为空"），用户无需查看日志即可理解问题

### Assumptions

- 假设后端命令已正确注册并可用，问题主要在前端调用方式或参数传递上
- 假设AI配置、系统提示词等数据的持久化机制已实现，问题在于前端未正确触发保存
- 假设主题切换的性能足够快，问题在于状态管理而非渲染性能
- 假设用户操作系统支持主题检测（Windows 10+、macOS 10.14+、现代Linux桌面环境）
- 假设应用已集成i18n国际化框架，问题在于语言切换逻辑而非缺少翻译文件
- 假设日志目录路径可通过配置或环境变量获取，且用户有读取权限
- 假设用户使用的是最新版本的应用，旧版本的已知问题不在本次修复范围内
