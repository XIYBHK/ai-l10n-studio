## æ¶æ„ï¼ˆç®€ç‰ˆï¼‰

### æ ¸å¿ƒæŠ€æœ¯æ ˆ

**å‰ç«¯**: React 18 + TypeScript + Ant Design + Zustand + SWR  
**åç«¯**: Tauri **2.8** + Rust (Tokio) + nom parser + 8 AI SDKs  
**æ„å»º**: Vite + Vitestï¼ˆ73 æµ‹è¯•ï¼Œ82.8% è¦†ç›–ç‡ï¼‰

### æå‡å¼€å‘æ•ˆç‡çš„æ ¸å¿ƒæ¶æ„

#### å››å±‚æ¶æ„è®¾è®¡ (2025-10é‡æ„)

```
ç»„ä»¶å±‚ (React Components)
   â†“ useAppData / useAsync
AppDataProvider (ç»Ÿä¸€æ•°æ®æä¾›è€…)
   â†“ SWRç¼“å­˜ + äº‹ä»¶ç›‘å¬
å‘½ä»¤å±‚ (commands.ts - 13 æ¨¡å—)
   â†“ ç»Ÿä¸€é”™è¯¯å¤„ç† + æ—¥å¿—
Tauri Commands (52 ä¸ª)
   â†“ åºåˆ—åŒ–/ååºåˆ—åŒ–
Rust æœåŠ¡å±‚ (services/)
   â†“ ConfigDraft (åŸå­æ›´æ–°)
Rust æŒä¹…åŒ–å±‚ (JSONæ–‡ä»¶)
```

**æ ¸å¿ƒæ”¹è¿›**:

- ç»Ÿä¸€æ•°æ®è®¿é—®: `AppDataProvider` é›†ä¸­ç®¡ç†æ‰€æœ‰å…¨å±€æ•°æ®
- å‘½ä»¤å±‚é‡æ„: `commands.ts` æ›¿ä»£æ—§çš„ `api.ts`ï¼Œæ¨¡å—åŒ–ç»„ç»‡
- Draft æ¨¡å¼: `ConfigDraft` å®ç°é…ç½®çš„åŸå­æ›´æ–°å’Œå¹¶å‘å®‰å…¨
- å¢å¼ºäº‹ä»¶æ¡¥æ¥: é˜²æŠ–+èŠ‚æµ+é²æ£’æ¸…ç†ï¼Œæ€§èƒ½æ›´ä¼˜

#### å¢å¼ºäº‹ä»¶ç³»ç»Ÿ (2025-10å‡çº§)

- UE é£æ ¼è®¾è®¡: `EventMap` å…¨å±€ç±»å‹å®šä¹‰ â†’ ç¼–è¯‘æ—¶æ£€æŸ¥
- å¢å¼ºæ¡¥æ¥: `useTauriEventBridgeEnhanced` æ”¯æŒé˜²æŠ–/èŠ‚æµ/é²æ£’æ¸…ç†
- è‡ªåŠ¨è½¬å‘: åç«¯äº‹ä»¶ â†’ `eventDispatcher` â†’ å‰ç«¯çŠ¶æ€
- è°ƒè¯•å‹å¥½: äº‹ä»¶å†å²è®°å½• + æ—¶é—´æˆ³ + payload å¿«ç…§
- é›†æˆæ–¹å¼: å·²é›†æˆåˆ° `AppDataProvider`ï¼Œè‡ªåŠ¨å¯ç”¨

#### ç»Ÿä¸€æ•°æ®å±‚ (AppDataProvider)

```typescript
// main.tsx - å…¨å±€åŒ…è£¹
<AppDataProvider>
  <App />
</AppDataProvider>

// ç»„ä»¶ä¸­ä½¿ç”¨
const { config, aiConfigs, termLibrary, refreshAll } = useAppData();
```

**æ ¸å¿ƒç‰¹æ€§**:

- SWR é›†æˆ: è‡ªåŠ¨ç¼“å­˜é…ç½®/TM/æœ¯è¯­åº“ï¼ˆé¿å…é‡å¤ IPC è°ƒç”¨ï¼‰
- ç»Ÿä¸€åˆ·æ–°: `refreshAll()` ä¸€é”®åˆ·æ–°æ‰€æœ‰æ•°æ®
- äº‹ä»¶åŒæ­¥: é›†æˆå¢å¼ºäº‹ä»¶æ¡¥æ¥ï¼Œè‡ªåŠ¨å¤±æ•ˆç¼“å­˜
- ç±»å‹å®‰å…¨: å®Œæ•´ TypeScript ç±»å‹æ¨æ–­

**æ›¿ä»£çš„æ—§æ¨¡å¼**:

- æ—§: æ¯ä¸ªç»„ä»¶å•ç‹¬è°ƒç”¨ `useSWR`
- æ–°: ç»Ÿä¸€é€šè¿‡ `useAppData` è®¿é—®å…¨å±€æ•°æ®

#### Channel API ç¿»è¯‘ï¼ˆç»Ÿä¸€è·¯å¾„ï¼‰

```rust
// Rust ç«¯é€šè¿‡ IPC Channel å‘é€è¿›åº¦å’Œç»Ÿè®¡
progress_tx.send(ProgressEvent { current, total, entry }).await;
stats_tx.send(StatsEvent { tm_hits, deduplicated, ... }).await;

// å‰ç«¯ useChannelTranslation è®¢é˜…
const { progress, stats } = useChannelTranslation(onProgress);
```

- é«˜æ€§èƒ½: æ›¿ä»£è½®è¯¢ï¼Œå®æ—¶æ¨é€
- ä½å†…å­˜: æµå¼å¤„ç†ï¼Œæ— éœ€ç¼“å­˜å…¨éƒ¨ç»“æœ
- å”¯ä¸€ç¿»è¯‘è·¯å¾„: å·²ç§»é™¤ Event API

#### ç»Ÿè®¡ç³»ç»Ÿï¼ˆEvent Sourcingï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Rust Backend (src-tauri)                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ translate_batch_with_channel                                â”‚
â”‚   â”œâ”€ AITranslator::translate_batch_with_sources()           â”‚
â”‚   â”‚   â”œâ”€ TM æŸ¥è¯¢ â†’ tm_hits++                                â”‚
â”‚   â”‚   â”œâ”€ å»é‡å¤„ç† â†’ deduplicated++                          â”‚
â”‚   â”‚   â””â”€ AI ç¿»è¯‘ â†’ ai_translated++, token ç»Ÿè®¡              â”‚
â”‚   â”œâ”€ å‘é€ç»Ÿè®¡åˆ° Channel: stats_tx.send()                    â”‚
â”‚   â””â”€ å‘é€äº‹ä»¶: emit('translation:after', stats)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend Event Bridge (useTauriEventBridge)                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç›‘å¬ Tauri Events â†’ è½¬å‘åˆ° EventDispatcher                  â”‚
â”‚   â”œâ”€ translation:before                                     â”‚
â”‚   â”œâ”€ translation-stats-update (Channel)                     â”‚
â”‚   â””â”€ translation:after                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ StatsManagerV2 (äº‹ä»¶ç¼–æ’å±‚)                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. translation:before â†’ ç”Ÿæˆ taskId                         â”‚
â”‚ 2. translation-stats-update â†’ StatsEngine èšåˆä¼šè¯ç»Ÿè®¡       â”‚
â”‚ 3. translation:after â†’ æ›´æ–°ç´¯è®¡ç»Ÿè®¡ï¼ˆæŒä¹…åŒ–ï¼‰                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ StatsEngine (äº‹ä»¶æº¯æºæ ¸å¿ƒ)                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ EventStore                                                  â”‚
â”‚   â”œâ”€ å­˜å‚¨æ‰€æœ‰ StatsEventï¼ˆå¸¦ eventId/taskId/timestampï¼‰     â”‚
â”‚   â”œâ”€ å¹‚ç­‰æ€§å»é‡ï¼ˆåŒ eventId åªå¤„ç†ä¸€æ¬¡ï¼‰                     â”‚
â”‚   â””â”€ äº‹ä»¶èšåˆå™¨ï¼ˆå®æ—¶è®¡ç®—ä¼šè¯ç»Ÿè®¡ï¼‰                          â”‚
â”‚                                                             â”‚
â”‚ è°ƒè¯•å·¥å…·                                                     â”‚
â”‚   â”œâ”€ getEventHistory() - æŸ¥çœ‹å®Œæ•´äº‹ä»¶æµ                     â”‚
â”‚   â”œâ”€ getTaskStats(taskId) - æŒ‰ä»»åŠ¡æŸ¥è¯¢                      â”‚
â”‚   â””â”€ reset() - æ¸…ç©ºäº‹ä»¶å­˜å‚¨                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Zustand Stores (çŠ¶æ€ç®¡ç†)                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ useSessionStore                                             â”‚
â”‚   â”œâ”€ sessionStats (åº”ç”¨å¯åŠ¨æ—¶é‡ç½®)                          â”‚
â”‚   â””â”€ èšåˆå½“å‰ä¼šè¯æ‰€æœ‰ç¿»è¯‘ç»Ÿè®¡                                â”‚
â”‚                                                             â”‚
â”‚ useStatsStore (æŒä¹…åŒ–åˆ° TauriStore)                          â”‚
â”‚   â”œâ”€ cumulativeStats (è·¨ä¼šè¯ç´¯åŠ )                           â”‚
â”‚   â””â”€ åŒ…å«å®Œæ•´ç»Ÿè®¡å­—æ®µï¼ˆtm_hits/deduplicated/tokens/costï¼‰   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ UI Components (AIWorkspace)                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ’¼ æœ¬æ¬¡ä¼šè¯ç»Ÿè®¡ (sessionStats)                               â”‚
â”‚   â”œâ”€ è®°å¿†åº“å‘½ä¸­: X / Y%                                     â”‚
â”‚   â”œâ”€ å»é‡èŠ‚çœ: X / Y%                                       â”‚
â”‚   â”œâ”€ AIè°ƒç”¨: X                                              â”‚
â”‚   â””â”€ é¢„ä¼°è´¹ç”¨: Â¥X.XX                                        â”‚
â”‚                                                             â”‚
â”‚ ğŸ“Š ç´¯è®¡ç»Ÿè®¡ (cumulativeStats)                                â”‚
â”‚   â”œâ”€ æ€»è®¡: X                                                â”‚
â”‚   â”œâ”€ å‘½ä¸­: X, å»é‡: X, AIè°ƒç”¨: X                            â”‚
â”‚   â””â”€ Token: X,XXX / Â¥X.XX                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ ¸å¿ƒç‰¹æ€§**:

1. **äº‹ä»¶æº¯æº**: æ‰€æœ‰ç»Ÿè®¡ä»¥äº‹ä»¶æµå­˜å‚¨ï¼Œå¯è¿½æº¯ã€å¯å®¡è®¡
2. **å¹‚ç­‰æ€§**: åŒä¸€äº‹ä»¶å¤šæ¬¡å¤„ç†ç»“æœä¸€è‡´ï¼Œé˜²æ­¢é‡å¤è®¡æ•°
3. **åŒå­˜å‚¨åˆ†ç¦»**: ä¼šè¯ç»Ÿè®¡ï¼ˆç¬æ€ï¼‰+ ç´¯è®¡ç»Ÿè®¡ï¼ˆæŒä¹…åŒ–ï¼‰
4. **ç±»å‹å®‰å…¨**: å®Œæ•´ TypeScript ç±»å‹å®šä¹‰ + ç¼–è¯‘æ—¶æ£€æŸ¥

#### 6ï¸âƒ£ **æ€§èƒ½ä¼˜åŒ–ç­–ç•¥**

- **æ™ºèƒ½åˆ†æ‰¹**: <10MB ç›´æ¥åŠ è½½ï¼Œ10-50MB 500æ¡/æ‰¹ï¼Œ>50MB 200æ¡/æ‰¹
- **å»é‡ç¿»è¯‘**: æ‰¹é‡å»é‡ï¼ˆå‡å°‘ 70% API è°ƒç”¨ï¼‰
- **ğŸ†• äº‹ä»¶èŠ‚æµ**: é…ç½®æ›´æ–° 500msï¼Œç»Ÿè®¡æ›´æ–° 500msï¼ˆæ€§èƒ½æ›´ä¼˜ï¼‰
- **LRU ç¼“å­˜**: ç¿»è¯‘è®°å¿†åº“æ¨¡å¼åŒ¹é…ç¼“å­˜
- **ğŸ†• æ—¥å¿—è½®è½¬**: å•ä¸ªæ–‡ä»¶æœ€å¤§ 128KBï¼Œè‡ªåŠ¨åˆ‡æ¢æ–°æ–‡ä»¶ï¼Œä¿ç•™æœ€æ–° 8 ä¸ª
- **ğŸ†• ä»£ç æ¸…ç†**: ç§»é™¤50è¡Œä¸´æ—¶è°ƒè¯•ä»£ç ï¼Œä¼˜åŒ–æ—¥å¿—æ€§èƒ½ï¼Œä¿®å¤æ‰€æœ‰linteré—®é¢˜

#### 7ï¸âƒ£ **å¤šAIä¾›åº”å•†æ¶æ„ï¼ˆæ’ä»¶åŒ– + ç±»å‹ç»Ÿä¸€ï¼‰**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ’ä»¶åŒ–ä¾›åº”å•†æ³¨å†Œè¡¨ (ProviderRegistry)             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å†…ç½®ä¾›åº”å•† (providers/)                          â”‚
â”‚   â”œâ”€ openai.rs    â†’ OpenAIProvider              â”‚
â”‚   â”œâ”€ moonshot.rs  â†’ MoonshotProvider            â”‚
â”‚   â””â”€ deepseek.rs  â†’ DeepSeekProvider            â”‚
â”‚                                                 â”‚
â”‚ åŠ¨æ€åŠ è½½ (plugin_loader.rs)                      â”‚
â”‚   â””â”€ ä» plugins/*.toml åŠ è½½å¤–éƒ¨ä¾›åº”å•†            â”‚
â”‚                                                 â”‚
â”‚ ProviderRegistry.get_provider(id) â†’ &dyn AIProvider â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ¨¡å‹å±‚ (models/)                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ openai.rs    â†’ get_openai_models()              â”‚
â”‚ moonshot.rs  â†’ get_moonshot_models()            â”‚
â”‚ deepseek.rs  â†’ get_deepseek_models()            â”‚
â”‚   â†“ è¿”å› Vec<ModelInfo>                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æˆæœ¬è®¡ç®— (CostCalculator)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ calculate_openai(&ModelInfo, ...) â†’ CostBreakdownâ”‚
â”‚   â”œâ”€ è¾“å…¥/è¾“å‡º token                             â”‚
â”‚   â”œâ”€ ç¼“å­˜å†™å…¥/è¯»å–                               â”‚
â”‚   â””â”€ èŠ‚çœè®¡ç®— (é«˜è¾¾90%)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AI ç¿»è¯‘å™¨ (AITranslator)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ†• new_with_config(AIConfig, ...)               â”‚
â”‚   â”œâ”€ config.provider_id: String                 â”‚
â”‚   â”œâ”€ ProviderRegistry.get_provider_info(id)     â”‚
â”‚   â””â”€ provider.get_model_info(model_id)          â”‚
â”‚       .expect("æ¨¡å‹å¿…é¡»å­˜åœ¨")  â† Fail Fast       â”‚
â”‚                                                 â”‚
â”‚ CostCalculator::calculate_openai(...)           â”‚
â”‚   â†’ token_stats.cost (USD)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ†• å‰åç«¯ç±»å‹ç»Ÿä¸€ (Zero Conversion)              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Rust: AIConfig { provider_id: String, ... }    â”‚
â”‚   â†“ serde(rename_all = "camelCase")            â”‚
â”‚ JSON: { providerId: string, ... }              â”‚
â”‚   â†“ Tauri IPC                                  â”‚
â”‚ TypeScript: AIConfig { providerId: string }    â”‚
â”‚   â†“ é›¶è½¬æ¢ï¼Œç›´æ¥ä½¿ç”¨                             â”‚
â”‚ React Components                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ ¸å¿ƒè®¾è®¡**ï¼š

- **æ’ä»¶åŒ–æ¶æ„** - `AIProvider` trait + `ProviderRegistry` å…¨å±€æ³¨å†Œè¡¨
- **ğŸ†• ç±»å‹ç»Ÿä¸€** - å‰åç«¯ `AIConfig` å®Œå…¨ä¸€è‡´ï¼Œé€šè¿‡ serde camelCase è‡ªåŠ¨è½¬æ¢
- **ğŸ†• providerId å­—ç¬¦ä¸²** - åºŸå¼ƒ `ProviderType` æšä¸¾ï¼Œä½¿ç”¨ `providerId: string`
- **å¼ºåˆ¶ ModelInfo** - æ— é™çº§é€»è¾‘ï¼Œæ¨¡å‹ä¸å­˜åœ¨ = ç«‹å³å¤±è´¥
- **ç»Ÿä¸€å®šä»·** - USD per 1M tokensï¼Œæ¸…é™¤æ‰€æœ‰ CNY æ ‡è®°
- **ç²¾ç¡®æˆæœ¬** - æ”¯æŒç¼“å­˜å®šä»·ï¼Œ30%å‘½ä¸­ç‡èŠ‚çœ27%æˆæœ¬
- **ç±»å‹å®‰å…¨** - ts-rs è‡ªåŠ¨ç”Ÿæˆ TypeScript ç±»å‹ï¼ˆ`ProviderInfo`, `ProxyConfig` ç­‰ï¼‰

#### 8ï¸âƒ£ **AI ç¿»è¯‘ç®¡çº¿**

```
PO æ–‡ä»¶ â†’ nom è§£æå™¨ â†’ å»é‡é˜Ÿåˆ—
   â†“
TM æŸ¥è¯¢ï¼ˆè®°å¿†åº“æ–‡ä»¶ï¼šé¦–æ¬¡83+å†…ç½®çŸ­è¯­ + ç”¨æˆ·å­¦ä¹ è¯æ¡ï¼‰
   â†“
AI ç¿»è¯‘ï¼ˆModelInfo + CostCalculator ç²¾ç¡®è®¡è´¹ï¼‰
   â†“
TM æ›´æ–° + äº‹ä»¶å‘å¸ƒ â†’ SWR å¤±æ•ˆ â†’ UI æ›´æ–°
```

**ğŸ†• ç¿»è¯‘è®°å¿†åº“é€»è¾‘** (2025-10-21):

- **é¦–æ¬¡ä½¿ç”¨**: è‡ªåŠ¨åŠ è½½83+æ¡å†…ç½®çŸ­è¯­åˆ°è®°å¿†åº“æ–‡ä»¶
- **åç»­ä½¿ç”¨**: åªæŸ¥è¯¢è®°å¿†åº“æ–‡ä»¶ï¼Œä¸å†è‡ªåŠ¨å›é€€åˆ°å†…ç½®çŸ­è¯­
- **ç”¨æˆ·æ§åˆ¶**: åˆ é™¤çš„è¯æ¡ä¸ä¼šè¢«è‡ªåŠ¨æ¢å¤ï¼Œä¿æŒç”¨æˆ·å®Œå…¨æ§åˆ¶æƒ
- **æ‰‹åŠ¨åŠ è½½**: ç”¨æˆ·å¯ä¸»åŠ¨åˆå¹¶å†…ç½®è¯åº“åˆ°å½“å‰è®°å¿†åº“

#### 9ï¸âƒ£ **ğŸ†• åç«¯é…ç½®ç®¡ç†ï¼ˆDraft æ¨¡å¼ï¼‰** - 2025-10

```rust
// è¯»å–é…ç½®ï¼ˆåªè¯»è®¿é—®ï¼‰
let draft = ConfigDraft::global().await;
let config = draft.data(); // MappedRwLockReadGuard
println!("Active AI: {}", config.active_config_index);
// config è‡ªåŠ¨é‡Šæ”¾è¯»é”

// ä¿®æ”¹é…ç½®ï¼ˆåŸå­æ›´æ–°ï¼‰
let draft = ConfigDraft::global().await;
{
    let mut config = draft.draft(); // MappedRwLockWriteGuard
    config.ai_configs.push(new_config);
}
draft.apply()?; // ä¿å­˜åˆ°ç£ç›˜ + å‘é€äº‹ä»¶
```

**æ ¸å¿ƒç‰¹æ€§**ï¼š

- âœ… **å¹¶å‘å®‰å…¨**ï¼š`parking_lot::RwLock` ä¿è¯çº¿ç¨‹å®‰å…¨
- âœ… **åŸå­æ›´æ–°**ï¼šé…ç½®ä¿®æ”¹è¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥
- âœ… **è‡ªåŠ¨æŒä¹…åŒ–**ï¼š`apply()` è‡ªåŠ¨ä¿å­˜åˆ°ç£ç›˜å¹¶å‘é€æ›´æ–°äº‹ä»¶
- âœ… **å…¨å±€å•ä¾‹**ï¼š`ConfigDraft::global()` æä¾›å…¨å±€è®¿é—®

**å‚è€ƒæº**ï¼š`clash-verge-rev/src-tauri/src/config/draft.rs`

#### ğŸ†• **ç³»ç»Ÿä¸»é¢˜æ£€æµ‹æ¶æ„** - 2025-10-15

**é—®é¢˜èƒŒæ™¯**ï¼šTauri webviewç¯å¢ƒä¸­ `window.matchMedia('(prefers-color-scheme: dark)')` æ— æ³•å‡†ç¡®åæ˜ çœŸå®ç³»ç»Ÿä¸»é¢˜

**è§£å†³æ–¹æ¡ˆ**ï¼šæ··åˆæ£€æµ‹ç­–ç•¥ + åŸç”ŸAPIä¼˜å…ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend (useTheme Hook)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ SystemThemeManager.handleSystemThemeChange()    â”‚
â”‚   â”œâ”€ 1ï¸âƒ£ åŸç”ŸAPIæ£€æµ‹ (ä¼˜å…ˆ)                      â”‚
â”‚   â”‚   â””â”€ systemCommands.getNativeSystemTheme()  â”‚
â”‚   â”œâ”€ 2ï¸âƒ£ åª’ä½“æŸ¥è¯¢æ£€æµ‹ (å¤‡ç”¨)                      â”‚
â”‚   â”‚   â””â”€ window.matchMedia()                    â”‚
â”‚   â”œâ”€ 3ï¸âƒ£ ç»“æœå¯¹æ¯” + è­¦å‘Š                         â”‚
â”‚   â””â”€ 4ï¸âƒ£ æ›´æ–°å…¨å±€çŠ¶æ€                            â”‚
â”‚       â””â”€ useAppStore.setSystemTheme()           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“ Tauri IPC
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Backend (Rust Commands)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ get_native_system_theme()                       â”‚
â”‚   â”œâ”€ Windows: æ³¨å†Œè¡¨æŸ¥è¯¢                        â”‚
â”‚   â”‚   â””â”€ HKCU\...\Personalize\AppsUseLightTheme â”‚
â”‚   â”œâ”€ macOS: defaults å‘½ä»¤                       â”‚
â”‚   â”‚   â””â”€ defaults read -g AppleInterfaceStyle    â”‚
â”‚   â”œâ”€ Linux: gsettings æŸ¥è¯¢                      â”‚
â”‚   â”‚   â””â”€ org.gnome.desktop.interface gtk-theme  â”‚
â”‚   â””â”€ è¿”å›: "dark" | "light"                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ ¸å¿ƒç‰¹æ€§**ï¼š

- âœ… **100% å‡†ç¡®æ€§**ï¼šç»•è¿‡webviewé™åˆ¶ï¼Œç›´æ¥ä»OSè·å–
- âœ… **ä¼˜é›…é™çº§**ï¼šåŸç”ŸAPIå¤±è´¥æ—¶è‡ªåŠ¨å›é€€åˆ°åª’ä½“æŸ¥è¯¢
- âœ… **è°ƒè¯•å‹å¥½**ï¼šè¯¦ç»†å¯¹æ¯”æ—¥å¿—ï¼Œå¸®åŠ©è¯Šæ–­ç¯å¢ƒé—®é¢˜
- âœ… **è·¨å¹³å°æ”¯æŒ**ï¼šWindows/macOS/Linuxç»Ÿä¸€æ¥å£
- âœ… **æ€§èƒ½ä¼˜åŒ–**ï¼šç¼“å­˜æ£€æµ‹ç»“æœï¼Œé¿å…é‡å¤ç³»ç»Ÿè°ƒç”¨

**é›†æˆåˆ°ä¸»é¢˜ç³»ç»Ÿ**ï¼š

```typescript
// å…¨å±€å•ä¾‹ç®¡ç†å™¨ï¼ˆé˜²æ­¢é‡å¤åˆå§‹åŒ–ï¼‰
export function initializeGlobalSystemThemeManager(setSystemTheme) {
  if (systemThemeListenerInitialized) return;

  const handleSystemThemeChange = async (forceUpdate = false) => {
    // æ··åˆæ£€æµ‹ç­–ç•¥
    const { nativeResult, mediaQueryResult, finalTheme } = await detectSystemTheme();

    // ä¸ä¸€è‡´è­¦å‘Š
    if (nativeResult !== mediaQueryResult) {
      log.warn('ç³»ç»Ÿä¸»é¢˜æ£€æµ‹ä¸ä¸€è‡´', { nativeResult, mediaQueryResult });
    }

    // æ›´æ–°å…¨å±€çŠ¶æ€ï¼ˆå•ä¸€æ•°æ®æºï¼‰
    setSystemTheme(finalTheme);
  };
}
```

**æŠ€æœ¯ä»·å€¼**ï¼š

- ğŸ¯ **è§£å†³æ¡†æ¶é™åˆ¶**ï¼šä¸ºTauriç”Ÿæ€è´¡çŒ®äº†webviewä¸»é¢˜æ£€æµ‹çš„æ ‡å‡†æ–¹æ¡ˆ
- ğŸ—ï¸ **æ¶æ„ç¤ºèŒƒ**ï¼šå±•ç¤ºäº†å¦‚ä½•ä¼˜é›…å¤„ç†è·¨å¹³å°ç³»ç»ŸAPIè°ƒç”¨
- ğŸ”§ **å¯å¤ç”¨æ€§**ï¼šå…¶ä»–Taurié¡¹ç›®å¯ç›´æ¥å€Ÿé‰´æ­¤å®ç°

---

### å¼€å‘å·¥ä½œæµ

```bash
npm run tauri:dev  # è‡ªåŠ¨çƒ­é‡è½½ï¼ˆVite HMR + Rust ç›‘æ§ï¼‰
npm run test       # Vitest ç›‘å¬æ¨¡å¼
npm run test:ui    # å¯è§†åŒ–æµ‹è¯•è°ƒè¯•

# æ–°å¢ï¼šä»£ç è§„èŒƒå·¥å…·
npm run format       # Prettier æ ¼å¼åŒ–å‰ç«¯ä»£ç 
npm run format:check # æ£€æŸ¥ä»£ç æ ¼å¼
npm run fmt          # Rust ä»£ç æ ¼å¼åŒ–
npm run lint:all     # æ£€æŸ¥æ‰€æœ‰ä»£ç æ ¼å¼
```

**å®Œæ•´æ–‡æ¡£**: `CLAUDE.md` Â§Architecture Overview & Development Guidelines
